{% extends "base.html" %}
{% set manage = t['channels_manage'] %}

{% block title %}{{ manage['title'] }} - {{ t['app']['title'] }}{% endblock %}

{% block extra_head %}
<style>
    .channels-page {
        max-width: 1120px;
        margin: 0 auto;
        padding: 2rem 1.5rem 3rem;
    }

    .page-header {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .page-header h1 {
        font-size: 2.1rem;
        font-weight: 700;
        margin: 0;
        color: #1f2933;
    }

    .page-header p {
        font-size: 1rem;
        color: #4b5563;
        margin: 0;
        max-width: 720px;
    }

    .subscription-card {
        background: linear-gradient(135deg, #eff3ff 0%, #e0f2ff 100%);
        border-radius: 16px;
        padding: 1.5rem 2rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .plan-chip {
        display: inline-flex;
        align-items: center;
        background: rgba(37, 99, 235, 0.12);
        color: #1d4ed8;
        font-weight: 600;
        font-size: 0.85rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
    }

    .usage-text {
        font-size: 1rem;
        color: #1f2933;
        margin: 0;
    }

    .limit-text {
        font-size: 0.95rem;
        color: #b45309;
        margin: 0;
    }

    .subscription-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .alert {
        border-radius: 12px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.5rem;
        font-size: 0.95rem;
        font-weight: 500;
    }

    .alert.success {
        background: #ecfdf5;
        color: #047857;
    }

    .alert.neutral {
        background: #f1f5f9;
        color: #1f2937;
    }

    .section-heading {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 1rem;
    }

    .section-heading h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2933;
        margin: 0;
    }

    .channel-card {
        background: #ffffff;
        border-radius: 18px;
        padding: 1.75rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.08);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
    }

    .channel-header {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .channel-title {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .channel-title h3 {
        font-size: 1.3rem;
        font-weight: 700;
        color: #111827;
        margin: 0;
        word-break: break-word;
    }

    .channel-subtitle {
        font-size: 0.95rem;
        color: #6b7280;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    .status-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .status-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.8rem;
        font-weight: 600;
        padding: 0.4rem 0.75rem;
        border-radius: 999px;
    }

    .status-live {
        background: rgba(16, 185, 129, 0.12);
        color: #047857;
    }

    .status-refresh {
        background: rgba(245, 158, 11, 0.15);
        color: #b45309;
    }

    .status-off {
        background: rgba(148, 163, 184, 0.15);
        color: #475569;
    }

    .source-pill {
        display: inline-flex;
        align-items: center;
        font-size: 0.75rem;
        padding: 0.35rem 0.6rem;
        border-radius: 8px;
        background: #f8fafc;
        color: #475569;
    }

    .source-pill.api {
        background: rgba(59, 130, 246, 0.12);
        color: #1d4ed8;
    }

    .source-note {
        font-size: 0.8rem;
        color: #ef4444;
        margin: 0;
    }

    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 1rem;
    }

    .metric-card {
        background: #f8fafc;
        border-radius: 14px;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .metric-card h4 {
        margin: 0;
        font-size: 0.85rem;
        color: #475569;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    .metric-card strong {
        font-size: 1.4rem;
        font-weight: 700;
        color: #0f172a;
    }

    .metric-card p {
        margin: 0;
        font-size: 0.85rem;
        color: #6b7280;
    }

    .channel-details {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .recent-posts {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
    }

    .recent-posts table {
        width: 100%;
        border-collapse: collapse;
    }

    .recent-posts th,
    .recent-posts td {
        padding: 0.65rem 0.85rem;
        text-align: left;
        font-size: 0.88rem;
    }

    .recent-posts th {
        background: #f8fafc;
        color: #475569;
        font-weight: 600;
    }

    .recent-posts td {
        color: #1f2937;
        border-top: 1px solid #e2e8f0;
    }

    .recent-empty {
        padding: 0.8rem;
        font-size: 0.85rem;
        color: #6b7280;
        text-align: center;
    }

    .view-pattern {
        border-left: 4px solid #3b82f6;
        background: #f3f4ff;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        font-size: 0.88rem;
        color: #1e293b;
    }

    .channel-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .btn.small {
        font-size: 0.85rem;
        padding: 0.45rem 0.9rem;
        border-radius: 8px;
    }

    .btn.secondary {
        background: #1d4ed8;
        color: #ffffff;
    }

    .btn.outline {
        background: transparent;
        border: 1px solid #1d4ed8;
        color: #1d4ed8;
    }

    .btn.danger {
        background: #dc2626;
        color: #ffffff;
    }

    .empty-card {
        background: #f8fafc;
        border-radius: 14px;
        padding: 1.75rem;
        text-align: center;
        color: #475569;
        font-size: 0.95rem;
    }

    .platform-section {
        margin-top: 2.5rem;
    }

    .platform-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1.25rem;
    }

    .platform-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 1.25rem;
        box-shadow: 0 16px 32px rgba(15, 23, 42, 0.06);
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .platform-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.1);
    }

    .platform-badge {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: #e0e7ff;
        color: #312e81;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.95rem;
    }

    .platform-card h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: #111827;
    }

    .platform-card p {
        margin: 0;
        font-size: 0.9rem;
        color: #4b5563;
        min-height: 40px;
    }

    .platform-features {
        list-style: disc;
        margin: 0;
        padding-left: 1.2rem;
        color: #475569;
        font-size: 0.85rem;
        flex: 1;
    }

    .platform-features li + li {
        margin-top: 0.35rem;
    }

    .modal {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        z-index: 1000;
    }

    .modal.open {
        display: flex;
    }

    .modal-card {
        background: #ffffff;
        border-radius: 16px;
        max-width: 520px;
        width: 100%;
        padding: 1.5rem;
        box-shadow: 0 20px 60px rgba(15, 23, 42, 0.25);
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2933;
    }

    .close-btn {
        background: transparent;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #64748b;
    }

    .setup-group {
        margin-bottom: 1rem;
    }

    .setup-group h4 {
        margin: 0 0 0.4rem 0;
        font-size: 1rem;
        color: #1f2937;
    }

    .setup-group ul {
        margin: 0;
        padding-left: 1.1rem;
        color: #4b5563;
        font-size: 0.9rem;
    }

    .setup-group li + li {
        margin-top: 0.3rem;
    }

    @media (max-width: 720px) {
        .channels-page {
            padding: 1.5rem 1rem 2.5rem;
        }

        .subscription-card {
            padding: 1.25rem 1.5rem;
        }

        .channel-card {
            padding: 1.25rem;
        }

        .channel-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .btn.small {
            width: 100%;
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="channels-page">
    <section class="page-header">
        <h1>{{ manage['title'] }}</h1>
        <p>{{ manage['subtitle'] }}</p>
    </section>

    <section class="subscription-card">
        <span class="plan-chip">{{ manage['usage']['plan_label'].format(plan=plan_label) }}</span>
        <p class="usage-text">{{ manage['usage']['summary'].format(current=current_channel_count, max=max_channels) }}</p>
        {% if limit_reached %}
        <p class="limit-text">{{ manage['usage']['limit_reached'] }}</p>
        {% endif %}
        <div class="subscription-actions">
            {% if limit_reached %}
            <a class="btn secondary small" href="/pricing">{{ manage['usage']['upgrade'] }}</a>
            {% endif %}
        </div>
    </section>

    {% if request.query_params.get('success') == 'true' %}
    <div class="alert success">{{ manage['alerts']['connected'] }}</div>
    {% elif request.query_params.get('disconnected') == 'true' %}
    <div class="alert neutral">{{ manage['alerts']['disconnected'] }}</div>
    {% endif %}

    <section class="connected-section">
        <div class="section-heading">
            <h2>{{ manage['connected']['title'].format(count=current_channel_count) }}</h2>
        </div>

        {% if channels %}
            {% for item in channels %}
                {% set channel = item.channel %}
                {% set snapshot = channel_snapshots.get(channel.id) or {} %}
                {% set followers = snapshot.get('followers', channel.followers) %}
                {% set growth = snapshot.get('growth_rate', channel.growth_rate) %}
                {% set engagement = snapshot.get('engagement_rate', channel.engagement_rate) %}
                {% set last_title = snapshot.get('last_post_title') or channel.last_post_title %}
                {% set last_date = snapshot.get('last_post_date') or channel.last_post_date %}
                {% set last_label = last_date|string %}
                {% set source_key = snapshot.get('source', 'mock') %}
                {% set source_text = manage['connected']['source'].get(source_key, '') %}
                <article class="channel-card">
                    <div class="channel-header">
                        <div class="channel-title">
                            <h3>{{ channel.account_name }}</h3>
                            <p class="channel-subtitle">{{ t['channels'].get(channel.platform, channel.platform.upper()) }}</p>
                        </div>
                        <div class="status-row">
                            {% if item.is_connected %}
                                {% if item.needs_refresh %}
                                <span class="status-chip status-refresh">{{ manage['connected']['status']['needs_refresh'] }}</span>
                                {% else %}
                                <span class="status-chip status-live">{{ manage['connected']['status']['connected'] }}</span>
                                {% endif %}
                            {% else %}
                                <span class="status-chip status-off">{{ manage['connected']['status']['disconnected'] }}</span>
                            {% endif %}
                            {% if source_text %}
                            <span class="source-pill {{ source_key }}">{{ source_text }}</span>
                            {% endif %}
                        </div>
                        {% if snapshot.get('error') %}
                        <p class="source-note">{{ snapshot.get('error') }}</p>
                        {% endif %}
                        <div class="metric-grid">
                            <div class="metric-card">
                                <h4>{{ manage['connected']['metrics']['followers']['label'] }}</h4>
                                <strong>{{ "{:,}".format((followers or 0)|int) }}</strong>
                                <p>{{ manage['connected']['metrics']['followers']['explain'] }}</p>
                            </div>
                            <div class="metric-card">
                                <h4>{{ manage['connected']['metrics']['engagement']['label'] }}</h4>
                                <strong>{{ "%.1f"|format(engagement or 0) }}%</strong>
                                <p>{{ manage['connected']['metrics']['engagement']['explain'] }}</p>
                            </div>
                            <div class="metric-card">
                                <h4>{{ manage['connected']['metrics']['growth']['label'] }}</h4>
                                <strong>{{ "%.1f"|format(growth or 0) }}%</strong>
                                <p>{{ manage['connected']['metrics']['growth']['explain'] }}</p>
                            </div>
                            <div class="metric-card">
                                <h4>{{ manage['connected']['metrics']['last_post']['label'] }}</h4>
                                {% if last_title %}
                                <strong>{{ last_label[:10] if last_label else "—" }}</strong>
                                <p>{{ last_title }}</p>
                                {% else %}
                                <strong>—</strong>
                                <p>{{ manage['connected']['metrics']['last_post']['no_data'] }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="channel-details">
                        <div class="recent-posts">
                            {% set posts = snapshot.get('recent_posts', []) %}
                            {% if posts %}
                            <table>
                                <thead>
                                    <tr>
                                        <th>{{ manage['connected']['recent_posts']['title'] }}</th>
                                        <th>{{ manage['connected']['recent_posts']['impressions'] }}</th>
                                        <th>{{ manage['connected']['recent_posts']['likes'] }}</th>
                                        <th>{{ manage['connected']['recent_posts']['comments'] }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for post in posts[:3] %}
                                    <tr>
                                        <td>{{ post.get('title') or '-' }}</td>
                                        <td>{{ "{:,}".format((post.get('impressions') or 0)|int) }}</td>
                                        <td>{{ "{:,}".format((post.get('likes') or 0)|int) }}</td>
                                        <td>{{ "{:,}".format((post.get('comments') or 0)|int) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% else %}
                            <div class="recent-empty">{{ manage['connected']['recent_posts']['empty'] }}</div>
                            {% endif %}
                        </div>

                        {% set hourly_views = snapshot.get('hourly_views', []) %}
                        {% if hourly_views %}
                            {% set stats = namespace(peak=None, trough=None) %}
                            {% for point in hourly_views %}
                                {% if stats.peak is none or point['views'] > stats.peak['views'] %}
                                    {% set stats.peak = point %}
                                {% endif %}
                                {% if stats.trough is none or point['views'] < stats.trough['views'] %}
                                    {% set stats.trough = point %}
                                {% endif %}
                            {% endfor %}
                            <div class="view-pattern">
                                <div>{{ manage['connected']['hourly_views']['peak'].format(hour=("%02d"|format(stats.peak['hour'])), views="{:,}".format(stats.peak['views'])) }}</div>
                                {% if stats.trough %}
                                <div>{{ manage['connected']['hourly_views']['off_peak'].format(hour=("%02d"|format(stats.trough['hour']))) }}</div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="view-pattern">
                                {{ manage['connected']['hourly_views']['no_data'] }}
                            </div>
                        {% endif %}

                        <div class="channel-actions">
                            <a class="btn secondary small" href="/dashboard">{{ manage['connected']['actions']['open_dashboard'] }}</a>
                            {% if item.needs_refresh %}
                            <button class="btn outline small" type="button" onclick="refreshToken({{ channel.id }})">{{ manage['connected']['actions']['refresh'] }}</button>
                            {% endif %}
                            <button class="btn danger small" type="button" data-account="{{ channel.account_name }}" onclick="disconnectChannel({{ channel.id }}, this.dataset.account)">{{ manage['connected']['actions']['disconnect'] }}</button>
                        </div>
                    </div>
                </article>
            {% endfor %}
        {% else %}
        <div class="empty-card">
            <strong>{{ manage['connected']['empty']['title'] }}</strong>
            <p>{{ manage['connected']['empty']['body'] }}</p>
        </div>
        {% endif %}
    </section>

    <section class="platform-section">
        <div class="section-heading">
            <h2>{{ manage['platforms']['title'] }}</h2>
        </div>
        <p style="color:#4b5563; margin-bottom:1.25rem;">{{ manage['platforms']['description'] }}</p>
        <div class="platform-grid">
            {% for platform in platforms %}
                {% set info = manage['platforms']['items'].get(platform.id, {}) %}
                <div class="platform-card" data-platform="{{ platform.id }}" onclick="showSetupInstructions('{{ platform.id }}')">
                    <span class="platform-badge">{{ platform.badge }}</span>
                    <h3>{{ info.get('name', platform.id|capitalize) }}</h3>
                    <p>{{ info.get('summary', '') }}</p>
                    <ul class="platform-features">
                        {% for feature in manage['platforms']['feature_points'] %}
                        <li>{{ feature }}</li>
                        {% endfor %}
                    </ul>
                    <button class="btn secondary small" type="button" onclick="event.stopPropagation(); connectPlatform('{{ platform.id }}')">
                        {{ manage['platforms']['cta'] }}
                    </button>
                </div>
            {% endfor %}
        </div>
    </section>
</div>

<div class="modal" id="setupModal">
    <div class="modal-card">
        <div class="modal-header">
            <h3 id="modalTitle">{{ manage['modal']['title'].format(platform='') }}</h3>
            <button class="close-btn" type="button" onclick="closeModal()">&times;</button>
        </div>
        <div id="modalBody"></div>
    </div>
</div>

<script>
const manageTexts = {{ manage | tojson }};
const platformInstructions = manageTexts.platforms.items || {};
const modalTitleTemplate = manageTexts.modal.title;
const modalCloseLabel = manageTexts.modal.close;
const usageLimitMessage = manageTexts.usage.limit_reached;
const limitReached = {{ 'true' if limit_reached else 'false' }};
const actionTexts = manageTexts.connected.actions;
const alertTexts = manageTexts.alerts;

const modal = document.getElementById('setupModal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');

function showSetupInstructions(platform) {
    const info = platformInstructions[platform];
    if (!info) {
        return;
    }
    const title = modalTitleTemplate.replace('{platform}', info.name || platform);
    modalTitle.textContent = title;

    const steps = info.setup || [];
    let html = '';
    steps.forEach(step => {
        html += '<div class="setup-group">';
        html += `<h4>${step.title}</h4>`;
        if (step.points && step.points.length) {
            html += '<ul>';
            step.points.forEach(point => {
                html += `<li>${point}</li>`;
            });
            html += '</ul>';
        }
        html += '</div>';
    });
    if (!html) {
        html = `<p>${manageTexts.platforms.description}</p>`;
    }
    modalBody.innerHTML = html;
    modal.classList.add('open');
}

function closeModal() {
    modal.classList.remove('open');
}

window.addEventListener('click', (event) => {
    if (event.target === modal) {
        closeModal();
    }
});

function connectPlatform(platform) {
    if (limitReached === 'true') {
        alert(usageLimitMessage);
        window.location.href = '/pricing';
        return;
    }
    window.location.href = `/channels/connect/${platform}`;
}

function disconnectChannel(channelId, accountName) {
    const message = actionTexts.confirm_disconnect.replace('{account}', accountName || '');
    if (!confirm(message)) {
        return;
    }
    fetch(`/channels/disconnect/${channelId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    }).then(async response => {
        const data = await response.json().catch(() => ({}));
        if (response.ok) {
            alert(alertTexts.disconnected);
            window.location.href = window.location.pathname + '?disconnected=true';
        } else {
            alert(data.detail || 'Request failed');
        }
    }).catch(() => {
        alert('Network error');
    });
}

function refreshToken(channelId) {
    fetch(`/channels/refresh/${channelId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    }).then(async response => {
        const data = await response.json().catch(() => ({}));
        if (response.ok) {
            alert(actionTexts.refresh);
            window.location.reload();
        } else {
            alert(data.detail || 'Request failed');
        }
    }).catch(() => {
        alert('Network error');
    });
}
</script>
{% endblock %}
