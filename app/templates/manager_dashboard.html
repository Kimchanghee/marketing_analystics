{% extends "base.html" %}
{% block content %}
<section class="dashboard-header">
    <h1>ê¸°ì—… ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <div class="manager-stats">
        <div class="stat-card">
            <span class="stat-value">{{ approved_creators|length }}</span>
            <span class="stat-label">ìŠ¹ì¸ëœ í¬ë¦¬ì—ì´í„°</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ pending_approvals|length }}</span>
            <span class="stat-label">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</span>
        </div>
        <div class="stat-card">
            <span class="stat-value">{{ total_channels }}</span>
            <span class="stat-label">ì´ ê´€ë¦¬ ì±„ë„</span>
        </div>
    </div>
</section>

{% if pending_approvals %}
<section class="approval-queue">
    <h2>ìŠ¹ì¸ ëŒ€ê¸° í</h2>
    <div class="approval-grid">
        {% for link in pending_approvals %}
        {% set creator = creator_lookup[link.creator_id] %}
        <article class="approval-card">
            <header>
                <h3>{{ creator.name or creator.email }}</h3>
                <span class="badge pending">ìŠ¹ì¸ ëŒ€ê¸°</span>
            </header>
            <div class="creator-info">
                <p><strong>ì´ë©”ì¼:</strong> {{ creator.email }}</p>
                <p><strong>ì¡°ì§:</strong> {{ creator.organization or '-' }}</p>
                <p><strong>ìš”ì²­ì¼:</strong> {{ link.connected_at.strftime('%Y-%m-%d') if link.connected_at else '-' }}</p>
                {% if link.creator_id in creator_subscriptions %}
                {% set sub = creator_subscriptions[link.creator_id] %}
                <p><strong>êµ¬ë… í”Œëœ:</strong> {{ t['subscriptions'][sub.tier.value] }}</p>
                <p><strong>ì±„ë„ ìˆ˜:</strong> {{ creator_channel_counts.get(link.creator_id, 0) }} / {{ sub.max_accounts }}</p>
                {% endif %}
            </div>
            <div class="approval-actions">
                <form method="post" action="/manager/approve" style="display: inline;">
                    <input type="hidden" name="creator_email" value="{{ creator.email }}">
                    <input type="hidden" name="manager_email" value="{{ user.email }}">
                    <input type="hidden" name="approve" value="true">
                    <button class="btn primary" type="submit">ìŠ¹ì¸</button>
                </form>
                <form method="post" action="/manager/approve" style="display: inline;">
                    <input type="hidden" name="creator_email" value="{{ creator.email }}">
                    <input type="hidden" name="manager_email" value="{{ user.email }}">
                    <input type="hidden" name="approve" value="false">
                    <button class="btn tertiary" type="submit">ê±°ì ˆ</button>
                </form>
            </div>
        </article>
        {% endfor %}
    </div>
</section>
{% endif %}

<section class="managed-creators">
    <h2>ê´€ë¦¬ ì¤‘ì¸ í¬ë¦¬ì—ì´í„°</h2>
    {% if approved_creators %}
    <div class="creator-grid">
        {% for link in approved_creators %}
        {% set creator = creator_lookup[link.creator_id] %}
        <article class="creator-card">
            <header>
                <h3>{{ creator.name or creator.email }}</h3>
                <span class="badge approved">ìŠ¹ì¸ë¨</span>
            </header>
            <div class="creator-summary">
                <p><strong>ì´ë©”ì¼:</strong> {{ creator.email }}</p>
                <p><strong>ì¡°ì§:</strong> {{ creator.organization or '-' }}</p>
                <p><strong>ì—°ê²°ì¼:</strong> {{ link.connected_at.strftime('%Y-%m-%d') if link.connected_at else '-' }}</p>
                {% if link.creator_id in creator_subscriptions %}
                {% set sub = creator_subscriptions[link.creator_id] %}
                <p><strong>êµ¬ë… í”Œëœ:</strong> {{ t['subscriptions'][sub.tier.value] }}</p>
                {% endif %}
            </div>

            {% if link.creator_id in creator_channels %}
            <div class="creator-channels">
                <h4>ì±„ë„ í˜„í™© ({{ creator_channels[link.creator_id]|length }}ê°œ)</h4>
                <div class="channel-summary">
                    {% for channel in creator_channels[link.creator_id] %}
                    <div class="mini-channel-card">
                        <div class="channel-header">
                            <strong>{{ t['channels'][channel.platform] if channel.platform in t['channels'] else channel.platform }}</strong>
                            <span class="account-name">{{ channel.account_name }}</span>
                        </div>
                        {% set snapshot = creator_snapshots.get(channel.id) %}
                        {% if snapshot %}
                        <div class="mini-metrics">
                            <div class="metric-item">
                                <span class="metric-icon">ğŸ‘¥</span>
                                <span class="metric-value">{{ snapshot['followers'] }}</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-icon">ğŸ“ˆ</span>
                                <span class="metric-value">{{ snapshot['growth_rate'] }}%</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-icon">ğŸ’¬</span>
                                <span class="metric-value">{{ snapshot['engagement_rate'] }}%</span>
                            </div>
                        </div>
                        {% if snapshot.get('recent_posts') %}
                        <div class="recent-post-mini">
                            <p class="post-title">ìµœê·¼: {{ snapshot['recent_posts'][0]['title'][:30] }}...</p>
                            <p class="post-stats">
                                ğŸ‘ {{ snapshot['recent_posts'][0]['likes'] }}
                                ğŸ’¬ {{ snapshot['recent_posts'][0]['comments'] }}
                            </p>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="creator-actions">
                <a href="/manager/creator/{{ creator.id }}" class="btn secondary">ìƒì„¸ ë³´ê¸°</a>
                <button class="btn tertiary" onclick="exportCreatorReport({{ creator.id }})">ë¦¬í¬íŠ¸ ë‚´ë³´ë‚´ê¸°</button>
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty-state">ì•„ì§ ìŠ¹ì¸ëœ í¬ë¦¬ì—ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
</section>

<section class="manager-tools">
    <h2>ê´€ë¦¬ ë„êµ¬</h2>
    <div class="tool-grid">
        <div class="tool-card">
            <h3>í¬ë¦¬ì—ì´í„° ì´ˆëŒ€</h3>
            <p>ìƒˆë¡œìš´ í¬ë¦¬ì—ì´í„°ë¥¼ ì´ˆëŒ€í•˜ì—¬ ì—°ê²° ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <form method="post" action="/manager/invite" class="invite-form">
                <input type="email" name="creator_email" placeholder="í¬ë¦¬ì—ì´í„° ì´ë©”ì¼" required>
                <button class="btn primary" type="submit">ì´ˆëŒ€ ë§í¬ ìƒì„±</button>
            </form>
            {% if invite_link %}
            <div class="invite-result">
                <p><strong>ì´ˆëŒ€ ë§í¬:</strong></p>
                <input type="text" readonly value="{{ invite_link }}" onclick="this.select()">
                <button class="btn tertiary" onclick="copyToClipboard('{{ invite_link }}')">ë³µì‚¬</button>
            </div>
            {% endif %}
        </div>

        <div class="tool-card">
            <h3>í†µí•© ë¦¬í¬íŠ¸</h3>
            <p>ëª¨ë“  ìŠ¹ì¸ëœ í¬ë¦¬ì—ì´í„°ì˜ í†µí•© ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.</p>
            <div class="export-actions">
                <a href="/manager/export/csv" class="btn secondary" download>CSV ë‹¤ìš´ë¡œë“œ</a>
                <a href="/manager/export/pdf" class="btn secondary" download>PDF ë‹¤ìš´ë¡œë“œ</a>
            </div>
        </div>
    </div>
</section>

<style>
.dashboard-header {
    margin-bottom: 2rem;
}

.manager-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.stat-card {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 8px;
    text-align: center;
    border: 1px solid var(--border-color);
}

.stat-value {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
    margin-bottom: 0.5rem;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.approval-queue, .managed-creators, .manager-tools {
    margin-bottom: 3rem;
}

.approval-grid, .creator-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

.approval-card, .creator-card {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.approval-card header, .creator-card header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border-color);
}

.badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
}

.badge.pending {
    background: #FFF3CD;
    color: #856404;
}

.badge.approved {
    background: #D4EDDA;
    color: #155724;
}

.creator-info, .creator-summary {
    margin-bottom: 1rem;
}

.creator-info p, .creator-summary p {
    margin: 0.5rem 0;
    font-size: 0.9rem;
}

.approval-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.creator-channels {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.creator-channels h4 {
    margin-bottom: 1rem;
    font-size: 1rem;
}

.channel-summary {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.mini-channel-card {
    background: var(--bg);
    padding: 1rem;
    border-radius: 6px;
    border: 1px solid var(--border-color);
}

.channel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.account-name {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.mini-metrics {
    display: flex;
    gap: 1rem;
    margin-bottom: 0.75rem;
}

.metric-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.metric-icon {
    font-size: 1rem;
}

.metric-value {
    font-size: 0.9rem;
    font-weight: 500;
}

.recent-post-mini {
    padding-top: 0.75rem;
    border-top: 1px solid var(--border-color);
}

.post-title {
    font-size: 0.85rem;
    margin-bottom: 0.25rem;
}

.post-stats {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.creator-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.tool-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

.tool-card {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.tool-card h3 {
    margin-bottom: 0.5rem;
}

.tool-card p {
    color: var(--text-secondary);
    margin-bottom: 1rem;
}

.invite-form {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.invite-form input[type="email"] {
    flex: 1;
    padding: 0.5rem;
    border: 1px solid var(--border-color);
    border-radius: 4px;
}

.invite-result {
    background: var(--bg);
    padding: 1rem;
    border-radius: 6px;
    margin-top: 1rem;
}

.invite-result input[type="text"] {
    width: 100%;
    padding: 0.5rem;
    margin: 0.5rem 0;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    font-size: 0.85rem;
}

.export-actions {
    display: flex;
    gap: 0.5rem;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
}
</style>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('ì´ˆëŒ€ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    });
}

function exportCreatorReport(creatorId) {
    window.location.href = `/manager/creator/${creatorId}/export`;
}
</script>
{% endblock %}
