{% extends "base.html" %}
{% block content %}
<section class="ai-pd-header">
    <h1>ğŸ¤– AI PD ë¹„ì„œ</h1>
    <p class="subtitle">AIê°€ ë‹¹ì‹ ì˜ {{ 'í¬ë¦¬ì—ì´í„° í™œë™' if user_type == 'creator' else 'í¬ë¦¬ì—ì´í„° ê´€ë¦¬' }}ì„ ë¶„ì„í•˜ê³  í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤</p>

    {% if user_type == 'creator' %}
    <div class="stats-overview">
        <div class="stat-box">
            <span class="stat-label">ì—°ê²°ëœ ì±„ë„</span>
            <span class="stat-value">{{ channels|length }}ê°œ</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">ì´ êµ¬ë…ì</span>
            <span class="stat-value">{{ '{:,}'.format(total_followers) }}</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">í‰ê·  ì°¸ì—¬ìœ¨</span>
            <span class="stat-value">{{ '%.1f'|format(avg_engagement) }}%</span>
        </div>
    </div>
    {% else %}
    <div class="stats-overview">
        <div class="stat-box">
            <span class="stat-label">ê´€ë¦¬ í¬ë¦¬ì—ì´í„°</span>
            <span class="stat-value">{{ total_creators }}ëª…</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">ì´ ì±„ë„</span>
            <span class="stat-value">{{ total_channels }}ê°œ</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">ì´ êµ¬ë…ì</span>
            <span class="stat-value">{{ '{:,}'.format(total_followers) }}</span>
        </div>
    </div>
    {% endif %}
</section>

<section class="ai-chat-section">
    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="ai-message welcome-message">
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    <p><strong>AI PD ë¹„ì„œì…ë‹ˆë‹¤!</strong></p>
                    {% if user_type == 'creator' %}
                    <p>ë‹¹ì‹ ì˜ ì†Œì…œ ë¯¸ë””ì–´ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ê³  ê°œì„  ë°©ì•ˆì„ ì œì•ˆí•´ë“œë¦½ë‹ˆë‹¤. ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”:</p>
                    <ul class="suggestion-list">
                        <li>ì–´ë–¤ í”Œë«í¼ì— ë” ì§‘ì¤‘í•´ì•¼ í• ê¹Œìš”?</li>
                        <li>ìµœê·¼ ê²Œì‹œë¬¼ì˜ ë°˜ì‘ì´ ì¢‹ì€ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”?</li>
                        <li>êµ¬ë…ì ì„±ì¥ë¥ ì„ ë†’ì´ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í•˜ë‚˜ìš”?</li>
                        <li>ì°¸ì—¬ìœ¨ì„ ê°œì„ í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì•Œë ¤ì£¼ì„¸ìš”</li>
                    </ul>
                    {% else %}
                    <p>ê´€ë¦¬ ì¤‘ì¸ í¬ë¦¬ì—ì´í„°ë“¤ì˜ ì„±ê³¼ë¥¼ ë¶„ì„í•˜ê³  ì „ëµì„ ì œì•ˆí•´ë“œë¦½ë‹ˆë‹¤. ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”:</p>
                    <ul class="suggestion-list">
                        <li>ì–´ë–¤ í¬ë¦¬ì—ì´í„°ê°€ ê°€ì¥ ì¢‹ì€ ì„±ê³¼ë¥¼ ë‚´ê³  ìˆë‚˜ìš”?</li>
                        <li>ì „ì²´ í¬íŠ¸í´ë¦¬ì˜¤ì˜ ê°•ì ê³¼ ì•½ì ì€ ë¬´ì—‡ì¸ê°€ìš”?</li>
                        <li>í¬ë¦¬ì—ì´í„°ë³„ ë§ì¶¤ ì „ëµì„ ì œì•ˆí•´ì£¼ì„¸ìš”</li>
                        <li>ë‹¤ìŒ ë¶„ê¸°ì— ì§‘ì¤‘í•´ì•¼ í•  ì•¡ì…˜ ì•„ì´í…œì€ ë¬´ì—‡ì¸ê°€ìš”?</li>
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>

        <form id="aiChatForm" class="chat-input-form">
            <textarea
                id="questionInput"
                name="question"
                placeholder="AI PDì—ê²Œ ì§ˆë¬¸í•˜ì„¸ìš”... (ìµœì†Œ 10ì)"
                rows="3"
                required
                minlength="10"
            ></textarea>
            <button type="submit" class="btn primary" id="sendBtn">
                <span class="btn-text">ì§ˆë¬¸í•˜ê¸°</span>
                <span class="btn-loader" style="display: none;">ë¶„ì„ ì¤‘...</span>
            </button>
        </form>
    </div>
</section>

<section class="ai-info">
    <h2>ğŸ’¡ AI PD ì„œë¹„ìŠ¤ ì•ˆë‚´</h2>
    <div class="info-grid">
        <div class="info-card">
            <h3>ğŸ¯ ê°œì¸í™”ëœ ì¸ì‚¬ì´íŠ¸</h3>
            <p>ë‹¹ì‹ ì˜ ì‹¤ì œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§ì¶¤í˜• ë¶„ì„ê³¼ ì œì•ˆì„ ì œê³µí•©ë‹ˆë‹¤.</p>
        </div>
        <div class="info-card">
            <h3>ğŸ“Š ì‹¤í–‰ ê°€ëŠ¥í•œ ì¡°ì–¸</h3>
            <p>êµ¬ì²´ì ì¸ ì•¡ì…˜ ì•„ì´í…œê³¼ ì˜ˆìƒ íš¨ê³¼ë¥¼ í•¨ê»˜ ì œì‹œí•©ë‹ˆë‹¤.</p>
        </div>
        <div class="info-card">
            <h3>ğŸ”’ ì•ˆì „í•œ ë°ì´í„°</h3>
            <p>ëª¨ë“  ë¶„ì„ì€ ì•”í˜¸í™”ëœ ì—°ê²°ì„ í†µí•´ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
        </div>
        <div class="info-card">
            <h3>âš¡ ë¹ ë¥¸ ì‘ë‹µ</h3>
            <p>Google Gemini AIë¥¼ í†µí•´ ì¦‰ì‹œ ë‹µë³€ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>
</section>

<style>
.ai-pd-header {
    text-align: center;
    margin-bottom: 2rem;
}

.ai-pd-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
}

.stat-box {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 12px;
    text-align: center;
    border: 2px solid var(--border-color);
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.stat-value {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
}

.ai-chat-section {
    margin: 3rem 0;
}

.chat-container {
    max-width: 900px;
    margin: 0 auto;
    background: var(--card-bg);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.chat-messages {
    min-height: 400px;
    max-height: 600px;
    overflow-y: auto;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--bg);
    border-radius: 12px;
}

.ai-message,
.user-message {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.ai-message .message-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.message-content {
    flex: 1;
    background: var(--surface-bg);
    padding: 1rem 1.5rem;
    border-radius: 12px;
    line-height: 1.6;
}

.user-message .message-content {
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
}

.message-content p {
    margin: 0.5rem 0;
}

.message-content strong {
    color: var(--primary);
}

.suggestion-list {
    margin: 1rem 0;
    padding-left: 1.5rem;
}

.suggestion-list li {
    margin: 0.5rem 0;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color 0.2s;
}

.suggestion-list li:hover {
    color: var(--primary);
}

.welcome-message {
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    padding: 1rem;
}

.chat-input-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.chat-input-form textarea {
    width: 100%;
    padding: 1rem;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    font-family: inherit;
    font-size: 1rem;
    resize: vertical;
    min-height: 80px;
    transition: border-color 0.2s;
}

.chat-input-form textarea:focus {
    outline: none;
    border-color: var(--primary);
}

.chat-input-form button {
    align-self: flex-end;
    min-width: 150px;
}

.ai-info {
    margin: 4rem 0;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.info-card {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

.info-card h3 {
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
}

.info-card p {
    color: var(--text-secondary);
    line-height: 1.6;
}

.btn-loader {
    display: inline-block;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>

<script>
// Handle suggestion clicks
document.querySelectorAll('.suggestion-list li').forEach(item => {
    item.addEventListener('click', function() {
        document.getElementById('questionInput').value = this.textContent;
        document.getElementById('questionInput').focus();
    });
});

// Handle form submission
document.getElementById('aiChatForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const questionInput = document.getElementById('questionInput');
    const question = questionInput.value.trim();
    const sendBtn = document.getElementById('sendBtn');
    const btnText = sendBtn.querySelector('.btn-text');
    const btnLoader = sendBtn.querySelector('.btn-loader');
    const chatMessages = document.getElementById('chatMessages');

    if (question.length < 10) {
        alert('ì§ˆë¬¸ì€ ìµœì†Œ 10ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    // Disable form
    sendBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoader.style.display = 'inline-block';
    questionInput.disabled = true;

    // Add user message to chat
    const userMessage = document.createElement('div');
    userMessage.className = 'user-message';
    userMessage.innerHTML = `
        <div class="message-avatar">ğŸ‘¤</div>
        <div class="message-content">
            <p>${question}</p>
        </div>
    `;
    chatMessages.appendChild(userMessage);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    try {
        // Send to API
        const formData = new FormData();
        formData.append('question', question);

        const response = await fetch('/ai-pd/ask', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Add AI response to chat
            const aiMessage = document.createElement('div');
            aiMessage.className = 'ai-message';
            aiMessage.innerHTML = `
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    ${data.answer.split('\n').map(line => `<p>${line}</p>`).join('')}
                </div>
            `;
            chatMessages.appendChild(aiMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Clear input
            questionInput.value = '';
        } else {
            throw new Error(data.detail || 'Unknown error');
        }
    } catch (error) {
        const errorMessage = document.createElement('div');
        errorMessage.className = 'ai-message';
        errorMessage.innerHTML = `
            <div class="message-avatar">âš ï¸</div>
            <div class="message-content">
                <p><strong>ì˜¤ë¥˜ ë°œìƒ</strong></p>
                <p>${error.message || 'ì§ˆë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'}</p>
            </div>
        `;
        chatMessages.appendChild(errorMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    } finally {
        // Re-enable form
        sendBtn.disabled = false;
        btnText.style.display = 'inline-block';
        btnLoader.style.display = 'none';
        questionInput.disabled = false;
        questionInput.focus();
    }
});
</script>
{% endblock %}
