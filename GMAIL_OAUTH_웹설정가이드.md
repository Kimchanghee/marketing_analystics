# Gmail API OAuth2 설정 - 웹에서 할 작업

현재 OAuth 동의 화면 설정까지 완료된 상태입니다.
이제 **Google Cloud Console에서 딱 1가지만** 하면 됩니다!

---

## 🌐 웹에서 해야 할 작업 (Google Cloud Console)

### ✅ 이미 완료된 작업
- [x] Google Cloud 프로젝트 생성
- [x] Gmail API 활성화
- [x] OAuth 동의 화면 구성
- [x] OAuth 클라이언트 ID 생성 (데스크톱 앱)
- [x] 테스트 사용자 추가 (ympartners.uk@gmail.com)

### 📥 남은 작업: OAuth 클라이언트 JSON 다운로드

**단계:**

1. **Google Cloud Console 접속**
   ```
   https://console.cloud.google.com/apis/credentials
   ```

2. **사용자 인증 정보 페이지로 이동**
   - 왼쪽 메뉴: API 및 서비스 → 사용자 인증 정보

3. **OAuth 2.0 클라이언트 ID 찾기**
   - "OAuth 2.0 클라이언트 ID" 섹션에서
   - 방금 만든 클라이언트 찾기 (유형: 데스크톱)

4. **JSON 다운로드**
   - 클라이언트 오른쪽의 **다운로드 아이콘 (⬇️)** 클릭
   - 또는 **⋮ (더보기)** → **JSON 다운로드** 클릭

5. **완료!**
   - 파일이 다운로드 폴더에 `client_secret_XXXXX.json` 형식으로 저장됨

---

## 💻 로컬에서 할 작업 (명령 프롬프트)

### 1️⃣ 다운로드한 JSON 파일 이동

**방법 A: 명령 프롬프트 사용**
```cmd
cd c:\Users\HOME\Documents\GitHub\marketing_analystics
move "%USERPROFILE%\Downloads\client_secret_*.json" credentials\client_secrets.json
```

**방법 B: 파일 탐색기 사용**
1. 다운로드 폴더에서 `client_secret_XXXXX.json` 파일 찾기
2. 파일을 다음 경로로 복사:
   ```
   c:\Users\HOME\Documents\GitHub\marketing_analystics\credentials\
   ```
3. 파일 이름을 `client_secrets.json`으로 변경

### 2️⃣ OAuth2 토큰 생성

```bash
python scripts\generate_gmail_token.py
```

**스크립트가 자동으로 하는 일:**
- ✅ `client_secrets.json` 파일 확인
- 🌐 **브라우저 자동 실행** → Google 로그인 페이지
- ⏳ 사용자가 로그인하고 권한 승인하기를 대기
- 💾 토큰을 `credentials/token.pickle`에 저장
- 📋 `.env` 파일에 추가할 내용 자동 출력
- ✅ `.env` 파일 자동 업데이트 (y 입력 시)

**브라우저에서 할 일:**
1. **ympartners.uk@gmail.com** 계정 선택
2. "Creator Control Center에서 Gmail 계정 접근 요청" 확인
3. **허용** 클릭
4. "인증이 완료되었습니다" 메시지 확인
5. 브라우저 창 닫기

**스크립트 결과 예시:**
```
======================================================================
Gmail OAuth2 토큰 생성 스크립트
======================================================================

✅ credentials/client_secrets.json 파일을 찾았습니다.

🌐 브라우저에서 Google 계정으로 로그인하세요...
(브라우저가 자동으로 열립니다)

✅ Google 계정 인증이 완료되었습니다!
✅ 토큰이 credentials/token.pickle에 저장되었습니다.

======================================================================
✅ Gmail OAuth2 토큰 생성 완료!
======================================================================

📋 다음 내용을 .env 파일에 추가하세요:

----------------------------------------------------------------------
GMAIL_SENDER_EMAIL=ympartners.uk@gmail.com
GMAIL_CREDENTIALS_JSON='{"token": "ya29...", "refresh_token": "1//...", ...}'
----------------------------------------------------------------------

❓ .env 파일에 자동으로 추가하시겠습니까? (y/n): y
✅ .env 파일에 자동으로 추가되었습니다!

======================================================================
🎉 설정이 완료되었습니다!
======================================================================

다음 단계:
1. .env 파일에 위 내용이 추가되었는지 확인
2. python test_gmail.py 실행하여 테스트
======================================================================
```

### 3️⃣ Gmail API 테스트

```bash
python test_gmail.py
```

**테스트 내용:**
1. ✅ 설정 확인 (환경 변수, 인증 정보)
2. ✅ 서비스 초기화
3. ✅ 텍스트 이메일 전송 (자기 자신에게)
4. ✅ HTML 이메일 전송 (자기 자신에게)

**테스트 성공 예시:**
```
╔════════════════════════════════════════════════════════════════════╗
║                    Gmail API 연동 테스트                           ║
╚════════════════════════════════════════════════════════════════════╝

======================================================================
1. Gmail API 설정 확인
======================================================================
✅ GMAIL_SENDER_EMAIL: ympartners.uk@gmail.com
✅ GMAIL_CREDENTIALS_JSON: 설정됨 (OAuth2 방식)

✅ Gmail API가 올바르게 설정되었습니다!

======================================================================
2. Gmail 서비스 초기화 테스트
======================================================================
✅ GmailService 인스턴스 생성 성공
   발신자 이메일: ympartners.uk@gmail.com

======================================================================
3. 테스트 이메일 전송
======================================================================

테스트 이메일을 ympartners.uk@gmail.com로 전송합니다...
(자기 자신에게 전송하여 스팸 방지)
✅ 이메일 전송 성공!

📬 ympartners.uk@gmail.com의 받은편지함을 확인하세요.

======================================================================
4. HTML 이메일 전송 테스트
======================================================================

HTML 이메일을 ympartners.uk@gmail.com로 전송합니다...
✅ HTML 이메일 전송 성공!
   Message ID: 18d5f8a2b3c4d5e6

📬 ympartners.uk@gmail.com의 받은편지함을 확인하세요.

======================================================================
테스트 결과 요약
======================================================================
✅ 통과 - 설정 확인
✅ 통과 - 서비스 초기화
✅ 통과 - 텍스트 이메일 전송
✅ 통과 - HTML 이메일 전송

======================================================================
총 4개 테스트 중 4개 통과 (100%)
======================================================================

🎉 모든 테스트를 통과했습니다!
Gmail API가 정상적으로 작동하고 있습니다.
```

### 4️⃣ 이메일 확인

Gmail에서 다음 2개의 이메일이 도착했는지 확인:
1. **[테스트] Gmail API 연동 테스트** (텍스트 이메일)
2. **[테스트] Gmail API HTML 이메일 테스트** (HTML 이메일)

---

## 📊 작업 체크리스트

### 🌐 웹 작업 (Google Cloud Console)
- [ ] Google Cloud Console에 로그인
- [ ] API 및 서비스 → 사용자 인증 정보 페이지 이동
- [ ] OAuth 2.0 클라이언트 ID에서 다운로드 아이콘 클릭
- [ ] `client_secret_XXXXX.json` 파일 다운로드 완료

### 💻 로컬 작업 (명령 프롬프트)
- [ ] 다운로드한 JSON을 `credentials\client_secrets.json`으로 이동
- [ ] `python scripts\generate_gmail_token.py` 실행
- [ ] 브라우저에서 Google 로그인 및 권한 승인
- [ ] `.env` 파일 자동 업데이트 확인 (y 입력)
- [ ] `python test_gmail.py` 실행
- [ ] 테스트 이메일 2개 수신 확인

---

## 🎯 요약

**웹에서 할 일:** OAuth 클라이언트 JSON 파일 다운로드 (1분)

**로컬에서 할 일:**
1. JSON 파일 이동 (30초)
2. 토큰 생성 스크립트 실행 + 브라우저 인증 (2분)
3. 테스트 실행 (1분)

**총 소요 시간: 약 5분**

---

## ❓ 문제 해결

### "client_secrets.json 파일이 없습니다" 오류
→ JSON 파일을 `credentials\client_secrets.json` 경로에 정확히 저장했는지 확인

### 브라우저가 열리지 않음
→ 수동으로 터미널에 표시된 URL을 복사하여 브라우저에 붙여넣기

### "This app isn't verified" 경고 표시
→ **고급** → **Creator Control Center로 이동(안전하지 않음)** 클릭
   (개발 중이므로 정상입니다)

### 토큰 생성 후 테스트 실패
1. `.env` 파일에 `GMAIL_SENDER_EMAIL=ympartners.uk@gmail.com` 추가 확인
2. `.env` 파일에 `GMAIL_CREDENTIALS_JSON='...'` 추가 확인
3. 스크립트를 다시 실행: `python scripts\generate_gmail_token.py`

---

## 📚 참고 문서

- 전체 설정 가이드: [GMAIL_API_SETUP.md](GMAIL_API_SETUP.md)
- Google 공식 문서: https://developers.google.com/gmail/api/quickstart/python
