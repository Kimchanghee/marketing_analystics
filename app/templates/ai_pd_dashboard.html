{% extends "base.html" %}
{% block content %}
<section class="ai-pd-header">
    <h1>🤖 AI PD 비서</h1>
    <p class="subtitle">AI가 당신의 {{ '크리에이터 활동' if user_type == 'creator' else '크리에이터 관리' }}을 분석하고 피드백을 제공합니다</p>

    {% if user_type == 'creator' %}
    <div class="stats-overview">
        <div class="stat-box">
            <span class="stat-label">연결된 채널</span>
            <span class="stat-value">{{ channels|length }}개</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">총 구독자</span>
            <span class="stat-value">{{ '{:,}'.format(total_followers) }}</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">평균 참여율</span>
            <span class="stat-value">{{ '%.1f'|format(avg_engagement) }}%</span>
        </div>
    </div>
    {% else %}
    <div class="stats-overview">
        <div class="stat-box">
            <span class="stat-label">관리 크리에이터</span>
            <span class="stat-value">{{ total_creators }}명</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">총 채널</span>
            <span class="stat-value">{{ total_channels }}개</span>
        </div>
        <div class="stat-box">
            <span class="stat-label">총 구독자</span>
            <span class="stat-value">{{ '{:,}'.format(total_followers) }}</span>
        </div>
    </div>
    {% endif %}
</section>

<section class="ai-chat-section">
    <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
            <div class="ai-message welcome-message">
                <div class="message-avatar">🤖</div>
                <div class="message-content">
                    <p><strong>AI PD 비서입니다!</strong></p>
                    {% if user_type == 'creator' %}
                    <p>당신의 소셜 미디어 성과를 분석하고 개선 방안을 제안해드립니다. 궁금한 것을 물어보세요:</p>
                    <ul class="suggestion-list">
                        <li>어떤 플랫폼에 더 집중해야 할까요?</li>
                        <li>최근 게시물의 반응이 좋은 이유는 무엇인가요?</li>
                        <li>구독자 성장률을 높이려면 어떻게 해야 하나요?</li>
                        <li>참여율을 개선할 수 있는 방법을 알려주세요</li>
                    </ul>
                    {% else %}
                    <p>관리 중인 크리에이터들의 성과를 분석하고 전략을 제안해드립니다. 궁금한 것을 물어보세요:</p>
                    <ul class="suggestion-list">
                        <li>어떤 크리에이터가 가장 좋은 성과를 내고 있나요?</li>
                        <li>전체 포트폴리오의 강점과 약점은 무엇인가요?</li>
                        <li>크리에이터별 맞춤 전략을 제안해주세요</li>
                        <li>다음 분기에 집중해야 할 액션 아이템은 무엇인가요?</li>
                    </ul>
                    {% endif %}
                </div>
            </div>
        </div>

        <form id="aiChatForm" class="chat-input-form">
            <textarea
                id="questionInput"
                name="question"
                placeholder="AI PD에게 질문하세요... (최소 10자)"
                rows="3"
                required
                minlength="10"
            ></textarea>
            <button type="submit" class="btn primary" id="sendBtn">
                <span class="btn-text">질문하기</span>
                <span class="btn-loader" style="display: none;">분석 중...</span>
            </button>
        </form>
    </div>
</section>

<section class="ai-info">
    <h2>💡 AI PD 서비스 안내</h2>
    <div class="info-grid">
        <div class="info-card">
            <h3>🎯 개인화된 인사이트</h3>
            <p>당신의 실제 데이터를 기반으로 맞춤형 분석과 제안을 제공합니다.</p>
        </div>
        <div class="info-card">
            <h3>📊 실행 가능한 조언</h3>
            <p>구체적인 액션 아이템과 예상 효과를 함께 제시합니다.</p>
        </div>
        <div class="info-card">
            <h3>🔒 안전한 데이터</h3>
            <p>모든 분석은 암호화된 연결을 통해 안전하게 처리됩니다.</p>
        </div>
        <div class="info-card">
            <h3>⚡ 빠른 응답</h3>
            <p>Google Gemini AI를 통해 즉시 답변을 받을 수 있습니다.</p>
        </div>
    </div>
</section>

<style>
.ai-pd-header {
    text-align: center;
    margin-bottom: 2rem;
}

.ai-pd-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.subtitle {
    font-size: 1.1rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
}

.stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 2rem;
}

.stat-box {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 12px;
    text-align: center;
    border: 2px solid var(--border-color);
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.stat-value {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: var(--primary);
}

.ai-chat-section {
    margin: 3rem 0;
}

.chat-container {
    max-width: 900px;
    margin: 0 auto;
    background: var(--card-bg);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
}

.chat-messages {
    min-height: 400px;
    max-height: 600px;
    overflow-y: auto;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: var(--bg);
    border-radius: 12px;
}

.ai-message,
.user-message {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.ai-message .message-avatar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.message-content {
    flex: 1;
    background: var(--surface-bg);
    padding: 1rem 1.5rem;
    border-radius: 12px;
    line-height: 1.6;
}

.user-message .message-content {
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
}

.message-content p {
    margin: 0.5rem 0;
}

.message-content strong {
    color: var(--primary);
}

.suggestion-list {
    margin: 1rem 0;
    padding-left: 1.5rem;
}

.suggestion-list li {
    margin: 0.5rem 0;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color 0.2s;
}

.suggestion-list li:hover {
    color: var(--primary);
}

.welcome-message {
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    padding: 1rem;
}

.chat-input-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.chat-input-form textarea {
    width: 100%;
    padding: 1rem;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    font-family: inherit;
    font-size: 1rem;
    resize: vertical;
    min-height: 80px;
    transition: border-color 0.2s;
}

.chat-input-form textarea:focus {
    outline: none;
    border-color: var(--primary);
}

.chat-input-form button {
    align-self: flex-end;
    min-width: 150px;
}

.ai-info {
    margin: 4rem 0;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.info-card {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

.info-card h3 {
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
}

.info-card p {
    color: var(--text-secondary);
    line-height: 1.6;
}

.btn-loader {
    display: inline-block;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>

<script>
// Handle suggestion clicks
document.querySelectorAll('.suggestion-list li').forEach(item => {
    item.addEventListener('click', function() {
        document.getElementById('questionInput').value = this.textContent;
        document.getElementById('questionInput').focus();
    });
});

// Handle form submission
document.getElementById('aiChatForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const questionInput = document.getElementById('questionInput');
    const question = questionInput.value.trim();
    const sendBtn = document.getElementById('sendBtn');
    const btnText = sendBtn.querySelector('.btn-text');
    const btnLoader = sendBtn.querySelector('.btn-loader');
    const chatMessages = document.getElementById('chatMessages');

    if (question.length < 10) {
        alert('질문은 최소 10자 이상 입력해주세요.');
        return;
    }

    // Disable form
    sendBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoader.style.display = 'inline-block';
    questionInput.disabled = true;

    // Add user message to chat
    const userMessage = document.createElement('div');
    userMessage.className = 'user-message';
    userMessage.innerHTML = `
        <div class="message-avatar">👤</div>
        <div class="message-content">
            <p>${question}</p>
        </div>
    `;
    chatMessages.appendChild(userMessage);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    try {
        // Send to API
        const formData = new FormData();
        formData.append('question', question);

        const response = await fetch('/ai-pd/ask', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Add AI response to chat
            const aiMessage = document.createElement('div');
            aiMessage.className = 'ai-message';
            aiMessage.innerHTML = `
                <div class="message-avatar">🤖</div>
                <div class="message-content">
                    ${data.answer.split('\n').map(line => `<p>${line}</p>`).join('')}
                </div>
            `;
            chatMessages.appendChild(aiMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Clear input
            questionInput.value = '';
        } else {
            throw new Error(data.detail || 'Unknown error');
        }
    } catch (error) {
        const errorMessage = document.createElement('div');
        errorMessage.className = 'ai-message';
        errorMessage.innerHTML = `
            <div class="message-avatar">⚠️</div>
            <div class="message-content">
                <p><strong>오류 발생</strong></p>
                <p>${error.message || '질문 처리 중 오류가 발생했습니다. 다시 시도해주세요.'}</p>
            </div>
        `;
        chatMessages.appendChild(errorMessage);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    } finally {
        // Re-enable form
        sendBtn.disabled = false;
        btnText.style.display = 'inline-block';
        btnLoader.style.display = 'none';
        questionInput.disabled = false;
        questionInput.focus();
    }
});
</script>
{% endblock %}
